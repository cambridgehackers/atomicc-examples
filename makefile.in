#
export DTOP := $(PWD)   # project directory
TOPDIR := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
CONNECTALDIR=$(TOPDIR)/../connectal
CONNECTALSDIR=$(TOPDIR)/connectal
SIMMAKE=$(TOPDIR)/../atomicc/simulation/Makefile.verilator

VERILOG_LIB_GENERATED := $(TOPDIR)/lib/generated
export VERILOG_LIB := $(VERILOG_LIB_GENERATED) $(VERILOG_LIB_GENERATED)/../verilog
CLANGBASE = $(TOPDIR)/../llvm/build/bin/
CPP = $(CLANGBASE)clang++ 
LLC = $(CLANGBASE)llc
LINK = $(CLANGBASE)llvm-link
CPPFLAGS = -I$(TOPDIR)/lib/ -I$(TOPDIR)/xilinx -I.
CPPFLAGS += -std=c++11 -fno-unwind-tables -fno-use-cxa-atexit -fno-cxx-exceptions
CPPFLAGS += -fblocks -fno-diagnostics-color
CPPFLAGS += -Xclang -disable-lifetime-markers
CPPFLAGS += -I/usr/include/c++/4.2.1 -I/usr/include/c++/5
CPPFLAGS += -I/usr/include/c++/5 -I/usr/include/x86_64-linux-gnu/c++/5
CPPFLAGS += -I/usr/include/x86_64-linux-gnu/
#   catch signal SIGSEGV
#   set follow-fork-mode child

#CPPFLAGS += -emit-llvm
#CPPFLAGS += -mllvm -dtrace

############################# for running verilator
#
# To compile/run a test:
#
#     make          (this generates the verilog and cppgen files from the original cpp source)
#     make verilator (this compiles the generated files, both for ubuntu.exe and vlsim)
#     make run      (this runs bin/ubuntu.exe)
#     make clean    (this cleans out the objects/etc that were created by 'make verilator')
#

.PHONY: verilator run zybo clean
compile: all

verilator:
	#PROJECT_CPP=$(PROJECT_CPP) 
	DTOP=$(DTOP) make -f $(SIMMAKE) verilator

run:
	#PROJECT_CPP=$(PROJECT_CPP) 
	DTOP=$(DTOP) make -f $(SIMMAKE) run

zybo:
	BOARD=zybo \
	MKTOP=mkZynqTop \
	OS=android \
	XILINX=1 \
	PhysAddrWidth=32 \
	CONNECTAL_BITS_DEPENDENCES=zybo/hw/mkTop.bit \
	CONNECTAL_EXENAME=android.exe \
	VERILOG_PATH="$(VERILOG_LIB)" \
	    make -f $(CONNECTALSDIR)/scripts/Makefile.connectal.build

clean:
	rm -rf verilator zybo SWSOCK*

trace:
	make
	make clean
	VERILATOR_TRACE=--trace make verilator
	rm -f dump.vcd
	DUMP_VCD=dump.vcd make run
