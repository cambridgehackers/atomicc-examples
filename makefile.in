#
V?=0
ifeq ($(V),0)
Q=@
VERBOSE_SWITCH=
else
Q=
VERBOSE_SWITCH=--verbose
endif

export DTOP := $(PWD)   # project directory
TOPDIR := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
CONNECTALDIR=$(TOPDIR)/../connectal
CONNECTALSDIR=$(TOPDIR)/connectal

VERILOG_LIB_GENERATED := $(TOPDIR)/lib/generated
export VERILOG_LIB := $(VERILOG_LIB_GENERATED) $(VERILOG_LIB_GENERATED)/../verilog
CLANGBASE = $(TOPDIR)/../llvm/build/bin/
CPP = $(CLANGBASE)clang++ 
LLC = $(CLANGBASE)llc
LINK = $(CLANGBASE)llvm-link
CPPFLAGS = -I$(TOPDIR)/lib/ -I$(TOPDIR)/xilinx -I.
CPPFLAGS += -std=c++11 -fno-unwind-tables -fno-use-cxa-atexit -fno-cxx-exceptions
CPPFLAGS += -fblocks -fno-diagnostics-color
CPPFLAGS += -Xclang -disable-lifetime-markers
CPPFLAGS += -I/usr/include/c++/4.2.1 -I/usr/include/c++/5
CPPFLAGS += -I/usr/include/c++/5 -I/usr/include/x86_64-linux-gnu/c++/5
CPPFLAGS += -I/usr/include/x86_64-linux-gnu/
#   catch signal SIGSEGV
#   set follow-fork-mode child

#CPPFLAGS += -emit-llvm
#CPPFLAGS += -mllvm -dtrace

############################# for running verilator
#
# To compile/run a test:
#
#     make          (this generates the verilog and cppgen files from the original cpp source)
#     make verilator (this compiles the generated files, both for ubuntu.exe and vlsim)
#     make run      (this runs bin/ubuntu.exe)
#     make clean    (this cleans out the objects/etc that were created by 'make verilator')
#

.PHONY: verilator run zybo clean
compile: all

verilator:
	BOARD=verilator make gen
	cd verilator; make

run:
	cd verilator; make run

zybo:
	BOARD=zybo make gen
	cd zybo; make

gen:
	$(CONNECTALSDIR)/scripts/makefilegen.py -B$(BOARD) --project-dir $(BOARD) \
	$(foreach f, $(CPPFILES), --source $f) \
	$(foreach f, $(ALL_CPPFILES2), --source2 $f) \
        $(foreach f, $(PRINTF_DATAFILE), --printfdata $f) \
	$(VERBOSE_SWITCH)
	touch $(BOARD)/Makefile.autotop

clean:
	rm -rf verilator zybo SWSOCK*

trace:
	make
	make clean
	VERILATOR_TRACE=--trace make verilator
	rm -f dump.vcd
	DUMP_VCD=dump.vcd make run
